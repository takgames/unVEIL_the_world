<!doctype html>
<html lang="ja" data-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>unVEIL the world ダメージシミュレーター</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="app-header container">
      <h1>unVEIL the world ダメージシミュレーター</h1>
      <div class="header-actions">
        <button id="resetBtn" class="btn icon-btn danger" aria-label="リセット" title="リセット">
          <span class="emoji">↺</span>
        </button>
        <button id="shareBtn" class="btn icon-btn" aria-label="共有" title="共有URL">
          <span class="emoji">🔗</span>
        </button>
        <button id="themeBtn" class="btn icon-btn" aria-label="テーマ切替" title="ライト/ダーク切替">
          <span class="emoji">🌓</span>
        </button>
        <button id="helpBtn" class="btn icon-btn" aria-label="ヘルプ" title="ヘルプ / 計算式">
          <span class="emoji">❔</span>
        </button>
      </div>
    </header>

    <main class="container main-grid" id="appRoot" tabindex="-1">
      <!-- プリセット -->
      <details id="grpPreset" class="card" aria-labelledby="lblPreset">
        <summary id="lblPreset">プリセット</summary>
        <div class="card-body grid gap">
          <div class="grid two-cols">
            <label class="stack">
              <span>プリセット名</span>
              <input id="presetName" type="text" placeholder="例) アタッカー汎用" />
            </label>
            <label class="stack">
              <span>プリセット一覧</span>
              <select id="presetSelect"></select>
            </label>
          </div>
          <div class="row wrap gap">
            <button id="savePreset" class="btn">保存/上書き</button>
            <button id="renamePreset" class="btn">名前変更</button>
            <button id="deletePreset" class="btn danger">削除</button>
            
          </div>
        </div>
      </details>

      <!-- ステータス -->
      <details id="grpStatus" class="card" open>
        <summary>ステータス</summary>
        <div class="card-body grid two-cols gap">
          <label class="stack"><span>基礎攻撃力</span><input type="number" id="baseAtk" min="0" step="1" /></label>
          <label class="stack"><span>補正攻撃力</span><input type="number" id="bonusAtk" min="0" step="1" value="0" /></label>
          <label class="stack"><span>会心率 %</span><input type="number" id="critRate" min="0" max="100" step="0.1" /></label>
          <label class="stack"><span>会心ダメージ %</span><input type="number" id="critDmg" min="0" step="0.1" /></label>
        </div>
      </details>

      <!-- 装備 -->
      <details id="grpEquip" class="card">
        <summary>装備</summary>
        <div class="card-body grid gap">
          <div class="equip-grid">
            <!-- グローブ -->
            <fieldset class="equip-card"><legend>グローブ</legend>
              <div class="grid two-cols gap">
                <label class="stack"><span>メイン (攻撃力)</span><input type="number" data-main-type="atk" data-slot="glove" class="mainVal" min="0" step="1"></label>
                <div></div>
              </div>
              <div class="subgrid">
                <label class="stack"><span>サブ 攻撃力</span><input type="number" data-sub="atk" data-slot="glove" min="0" step="1"></label>
                <label class="stack"><span>サブ 攻撃力補正 %</span><input type="number" data-sub="atkPct" data-slot="glove" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心率 %</span><input type="number" data-sub="critRate" data-slot="glove" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心ダメージ %</span><input type="number" data-sub="critDmg" data-slot="glove" min="0" step="0.1"></label>
              </div>
            </fieldset>

            <!-- 服 -->
            <fieldset class="equip-card"><legend>服</legend>
              <div class="grid two-cols gap">
                <label class="stack"><span>メイン (その他)</span><input type="number" data-main-type="other" data-slot="armor" class="mainVal" min="0" step="1" placeholder="—"></label>
                <div></div>
              </div>
              <div class="subgrid">
                <label class="stack"><span>サブ 攻撃力</span><input type="number" data-sub="atk" data-slot="armor" min="0" step="1"></label>
                <label class="stack"><span>サブ 攻撃力補正 %</span><input type="number" data-sub="atkPct" data-slot="armor" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心率 %</span><input type="number" data-sub="critRate" data-slot="armor" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心ダメージ %</span><input type="number" data-sub="critDmg" data-slot="armor" min="0" step="0.1"></label>
              </div>
            </fieldset>

            <!-- 紋章 -->
            <fieldset class="equip-card"><legend>紋章</legend>
              <div class="grid two-cols gap">
                <label class="stack">
                  <span>メイン 種類</span>
                  <select data-slot="emblem" class="mainType">
                    <option value="atk">攻撃力</option>
                    <option value="atkPct">攻撃力補正 %</option>
                    <option value="elemDmgPct">属性ダメージ %</option>
                    <option value="other">その他</option>
                  </select>
                </label>
                <label class="stack"><span>メイン 値</span><input type="number" data-slot="emblem" class="mainVal" min="0" step="0.1" placeholder="—"></label>
              </div>
              <div class="subgrid">
                <label class="stack"><span>サブ 攻撃力</span><input type="number" data-sub="atk" data-slot="emblem" min="0" step="1"></label>
                <label class="stack"><span>サブ 攻撃力補正 %</span><input type="number" data-sub="atkPct" data-slot="emblem" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心率 %</span><input type="number" data-sub="critRate" data-slot="emblem" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心ダメージ %</span><input type="number" data-sub="critDmg" data-slot="emblem" min="0" step="0.1"></label>
              </div>
            </fieldset>

            <!-- 指輪 -->
            <fieldset class="equip-card"><legend>指輪</legend>
              <div class="grid two-cols gap">
                <label class="stack">
                  <span>メイン 種類</span>
                  <select data-slot="ring" class="mainType">
                    <option value="atk">攻撃力</option>
                    <option value="atkPct">攻撃力補正 %</option>
                    <option value="critRate">会心率 %</option>
                    <option value="critDmg">会心ダメージ %</option>
                    <option value="other">その他</option>
                  </select>
                </label>
                <label class="stack"><span>メイン 値</span><input type="number" data-slot="ring" class="mainVal" min="0" step="0.1" placeholder="—"></label>
              </div>
              <div class="subgrid">
                <label class="stack"><span>サブ 攻撃力</span><input type="number" data-sub="atk" data-slot="ring" min="0" step="1"></label>
                <label class="stack"><span>サブ 攻撃力補正 %</span><input type="number" data-sub="atkPct" data-slot="ring" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心率 %</span><input type="number" data-sub="critRate" data-slot="ring" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心ダメージ %</span><input type="number" data-sub="critDmg" data-slot="ring" min="0" step="0.1"></label>
              </div>
            </fieldset>

            <!-- ブローチ -->
            <fieldset class="equip-card"><legend>ブローチ</legend>
              <div class="grid two-cols gap">
                <label class="stack">
                  <span>メイン 種類</span>
                  <select data-slot="brooch" class="mainType">
                    <option value="atk">攻撃力</option>
                    <option value="atkPct">攻撃力補正 %</option>
                    <option value="critDmg">会心ダメージ %</option>
                    <option value="other">その他</option>
                  </select>
                </label>
                <label class="stack"><span>メイン 値</span><input type="number" data-slot="brooch" class="mainVal" min="0" step="0.1" placeholder="—"></label>
              </div>
              <div class="subgrid">
                <label class="stack"><span>サブ 攻撃力</span><input type="number" data-sub="atk" data-slot="brooch" min="0" step="1"></label>
                <label class="stack"><span>サブ 攻撃力補正 %</span><input type="number" data-sub="atkPct" data-slot="brooch" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心率 %</span><input type="number" data-sub="critRate" data-slot="brooch" min="0" step="0.1"></label>
                <label class="stack"><span>サブ 会心ダメージ %</span><input type="number" data-sub="critDmg" data-slot="brooch" min="0" step="0.1"></label>
              </div>
            </fieldset>
          </div>

          <!-- 合計 -->
          <div class="totals card subtle">
            <div class="totals-row"><span>装備 攻撃力 合計</span><output id="sumEquipAtk">0</output></div>
            <div class="totals-row"><span>装備 攻撃力補正 % 合計</span><output id="sumEquipAtkPct">0</output></div>
            <div class="totals-row"><span>装備 会心率 % 合計</span><output id="sumEquipCritRate">0</output></div>
            <div class="totals-row"><span>装備 会心ダメージ % 合計</span><output id="sumEquipCritDmg">0</output></div>
            <div class="totals-row"><span>装備 属性ダメージ % 合計</span><output id="sumEquipElemDmgPct">0</output></div>
          </div>
        </div>
      </details>

      <!-- スキル -->
      <details id="grpSkill" class="card" open>
        <summary>スキル</summary>
        <div class="card-body grid two-cols gap">
          <label class="stack"><span>スキル攻撃 %</span><input type="number" id="skillPct" min="0" step="0.1" /></label>
          <label class="stack"><span>スキル固定値</span><input type="number" id="skillFlat" min="0" step="1" value="0" /></label>
        </div>
      </details>

      <!-- 戦闘中効果 -->
      <details id="grpBattle" class="card" open>
        <summary>戦闘中効果</summary>
        <div class="card-body grid two-cols gap">
          <label class="stack"><span>攻撃力アップ %</span><input type="number" id="atkUpPct" min="0" step="0.1" value="0" /></label>
          <label class="stack"><span>ダメージアップ %</span><input type="number" id="dmgUpPct" min="0" step="0.1" value="0" /></label>
          <label class="stack"><span>カードダメージアップ %</span><input type="number" id="cardDmgUpPct" min="0" step="0.1" value="0" /></label>
          <label class="stack"><span>属性ダメージアップ %</span><input type="number" id="elemDmgUpPct" min="0" step="0.1" value="0" /></label>
        </div>
      </details>

      <!-- 敵の詳細 -->
      <details id="grpEnemy" class="card" open>
        <summary>敵の詳細</summary>
        <div class="card-body grid two-cols gap">
          <label class="stack"><span>防御力</span><input type="number" id="enemyDef" min="0" step="1" value="0" /></label>
          <label class="stack"><span>属性相性</span>
            <select id="affinity">
              <option value="none">なし</option>
              <option value="adv">有利</option>
              <option value="dis">不利</option>
            </select>
          </label>
          <label class="row align-center gap-sm checkbox-inline"><input type="checkbox" id="isBreak" /> <span>ブレイク状態</span></label>
        </div>
      </details>

      <!-- 計算の内訳 -->
      <details id="grpBreakdown" class="card">
        <summary>計算の内訳</summary>
        <div class="card-body">
          <div class="breakdown-grid">
            <div><span title="Σ装備攻撃力 + 基礎攻撃力 × (Σ装備攻撃力補正%/100)">装備補正攻撃力</span><strong id="outEquipAdjAtk">0</strong></div>
            <div><span title="(基礎+補正+装備補正) × (1+攻撃力アップ%)">最終攻撃力</span><strong id="outFinalAtk">0</strong></div>
            <div><span title="最終攻撃力 × (スキル%)">スキル倍率適用後</span><strong id="outAfterSkillMult">0</strong></div>
            <div><span title="(上記) + スキル固定値">スキル固定値加算後</span><strong id="outAfterSkillAdd">0</strong></div>
            <div><span title="(上記) × (1+ダメージアップ%)">ダメージUP適用後</span><strong id="outAfterDmgUp">0</strong></div>
            <div><span title="(上記) × (1+カードダメージアップ%)">カードダメUP適用後</span><strong id="outAfterCardUp">0</strong></div>
            <div><span title="属性ダメ%（戦闘中+装備）合算">属性ダメ合算%</span><strong id="outAllElemPct">0</strong></div>
            <div><span title="(上記) × (1+属性ダメ合算%)">属性ダメ適用後</span><strong id="outAfterElemUp">0</strong></div>
            <div><span title="有利1.25/不利0.85/なし1.00">属性相性倍率</span><strong id="outAffinity">1.00</strong></div>
            <div><span title="(上記) × 属性相性">属性相性適用後</span><strong id="outAfterAffinity">0</strong></div>
            <div><span title="ブレイク時1.3/通常1.0">ブレイク倍率</span><strong id="outBreak">1.00</strong></div>
            <div><span title="(上記) × ブレイク倍率">ブレイク適用後</span><strong id="outAfterBreak">0</strong></div>
            <div><span title="exp(-0.001058×防御 + 0.000000715×防御^2)">防御係数</span><strong id="outDefCoeff">1.0000</strong></div>
            <div><span title="(上記) × 防御係数">防御適用後</span><strong id="outAfterDefense">0</strong></div>
            <div><span title="会心率（装備込み、上限100%）">最終会心率%</span><strong id="outAllCritRate">0</strong></div>
            <div><span title="会心ダメ（装備込み）">最終会心ダメ%</span><strong id="outAllCritDmg">0</strong></div>
          </div>
        </div>
      </details>
    </main>

    <!-- 結果 (常時 下部表示) -->
    <section class="results" aria-live="polite">
      <div class="container results-inner">
        <div class="results-head row space-between align-center">
          <strong>結果</strong>
          <div class="actions-inline">
            <span id="badgeA" class="badgeA badge-btn" role="button" tabindex="0" aria-label="比較元">
              <span class="label-full">比較元:</span><span class="label-short">A:</span>
              <span id="badgeAName" class="name">現在</span>
            </span>

            <span id="badgeB" class="badgeB badge-btn" role="button" tabindex="0" aria-label="比較先">
              <span class="label-full">比較先:</span><span class="label-short">B:</span>
              <span id="badgeBName" class="name">未選択</span>
            </span>

            <!-- 比較先セレクト（PC/横画面用）。縦画面では自動で非表示にします -->
            <select id="compareSelect" title="比較先を選択"></select>

            <button id="compareSwap"  class="btn xs" type="button" title="入替">↔︎</button>
            <button id="compareClear" class="btn xs" type="button" title="解除">×</button>
            <button id="compareSave"  class="btn xs" type="button" title="比較先を保存" hidden>保存</button>
          </div>
        </div>
        <div class="chart" role="img" aria-label="ダメージチャート">
          <!-- 奥側：B（比較）ストライプ -->
          <div id="barBNormal" class="bar barB barB-normal"></div>
          <div id="barBAvg"    class="bar barB barB-avg"></div>
          <div id="barBCrit"   class="bar barB barB-crit"></div>

          <!-- 手前：A（現状）既存の3本がこの後に来る -->
          <div id="barNormal"  class="bar bar-normal"></div>
          <div id="barAvg"     class="bar bar-avg"></div>
          <div id="barCrit"    class="bar bar-crit"></div>

          <!-- 最前面：A>B のとき差分を“赤ストライプ”で可視化 -->
          <div id="barDefNormal" class="bar barDef barDef-normal"></div>
          <div id="barDefAvg"    class="bar barDef barDef-avg"></div>
          <div id="barDefCrit"   class="bar barDef barDef-crit"></div>
        </div>
        <div class="results-values">
          <div>
            <span class="chip chip-normal">通常</span>
            <strong id="outNormal"></strong>
            <span id="deltaNormal" class="delta-chip" hidden></span>
          </div>
          <div>
            <span class="chip chip-avg">平均</span>
            <strong id="outAverage"></strong>
            <span id="deltaAverage" class="delta-chip" hidden></span>
          </div>
          <div>
            <span class="chip chip-crit">会心</span>
            <strong id="outCrit"></strong>
            <span id="deltaCrit" class="delta-chip" hidden></span>
          </div>
        </div>
      </div>
    </section>

    <footer class="app-footer container">
      <div>©2025 Tak</div>
      <div class="muted small">本シミュレーターは実測検証に基づいた近似値の推測を目的としているため、実際のゲームプレイにおける結果と一致することを保証するものではありません。</div>
    </footer>

    <!-- トースト -->
    <div id="toast" role="status" aria-live="polite"></div>

    <!-- 共有ダイアログ（2ボタン方式） -->
    <dialog id="shareDialog" aria-labelledby="shareTitle" tabindex="-1">
      <div class="dialog-card">
        <h3 id="shareTitle">共有URLをコピー</h3>
        <p class="muted small">コピー形式を選んでください</p>
        <div class="row gap">
          <button id="copyUrl" type="button" class="btn primary">URLをコピー</button>
          <button id="copyMd"  type="button" class="btn">Markdownでコピー</button>
          <button id="closeShare" type="button" class="btn">閉じる</button>
        </div>
      </div>
    </dialog>

    <!-- ヘルプダイアログ -->
    <dialog id="helpDialog" aria-labelledby="helpTitle" tabindex="-1">
      <div class="dialog-card" style="max-height:min(70vh,640px); overflow:auto">
        <h3 id="helpTitle">ヘルプ / 計算式</h3>
        <p class="muted small">このシミュレーターの計算式とヒント</p>
        <h4>計算式</h4>
        <pre class="subtle card" style="padding:12px; overflow:auto"><code>
    [装備補正攻撃力] = Σ装備攻撃力 + (基礎攻撃力 × (Σ装備攻撃力補正% / 100))
    [最終攻撃力] = (基礎攻撃力 + 補正攻撃力 + 装備補正攻撃力) × (1 + 攻撃力アップ% / 100)
    [属性相性] = なし:1.00 / 有利:1.25 / 不利:0.85
    [ブレイク値] = ブレイク時:1.3 / 通常:1.0
    [防御係数] = e^-(0.001058×防御 − 0.000000715×防御^2)
    [通常ダメ] = (((最終攻撃力 × (スキル%)) + スキル固定) × (1+ダメ%) × (1+カード%) × (1+属性%) × 属性相性 × ブレイク × 防御係数)
    [会心ダメ] = 通常ダメ × (1 + 会心ダメ% / 100)
    [平均ダメ] = 通常ダメ × (1 + (会心ダメ% / 100) × (会心率% / 100))
    ※ 会心率は上限100%
        </code></pre>
        <h4>Tips</h4>
        <ul>
          <li>「その他」のメインは値入力できません（空白）。</li>
          <li>数値が<code>0</code>のフィールドは、フォーカス時に一時的に空白化します（フォーカスアウトで<code>0</code>に戻ります）。</li>
          <li>共有URLはBase64圧縮で<code>?z=...</code>に埋め込みます。</li>
        </ul>
        <div class="row gap" style="margin-top:12px">
          <button id="closeHelp" type="button" class="btn">閉じる</button>
        </div>
      </div>
    </dialog>

    <!-- 比較先ピッカー（iPhone縦向けのボトムシート） -->
    <dialog id="comparePicker" class="sheet" aria-labelledby="cmpTitle">
      <div class="sheet-inner">
        <div class="sheet-handle"></div>
        <h3 id="cmpTitle">比較先を選択</h3>
        <input id="cmpSearch" class="input" type="search" placeholder="プリセットを検索" autocomplete="off">
        <ul id="cmpList" class="list"></ul>
        <div class="row gap" style="margin-top:8px">
          <button id="cmpClear" class="btn xs">比較なし</button>
          <button id="cmpClose" class="btn xs">閉じる</button>
        </div>
      </div>
    </dialog>

    <!-- SVG Sprite (minimal) -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
      <!-- reset-ccw -->
      <symbol id="reset-ccw" viewBox="0 0 24 24">
        <path d="M3 4v6h6" />
        <path d="M3.5 10A8.5 8.5 0 1 0 7 5.5" />
      </symbol>
      <!-- link-2 -->
      <symbol id="link-2" viewBox="0 0 24 24">
        <path d="M15 7h2.5a4.5 4.5 0 1 1 0 9H15" />
        <path d="M9 16H6.5a4.5 4.5 0 1 1 0-9H9" />
        <path d="M8 12h8" />
      </symbol>
      <!-- sun-moon -->
      <symbol id="sun-moon" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="4" />
        <path d="M12 2v2M12 20v2M2 12h2M20 12h2" />
        <path d="M21 12.6A9 9 0 0 1 11.4 3" />
      </symbol>
      <!-- help-circle -->
      <symbol id="help-circle" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="9" />
        <path d="M9 9c0-2 2-3 3-3s3 1 3 3c0 2-2 2-2 3v1" />
        <path d="M12 17h.01" />
      </symbol>
    </svg>

    <script src="app.js" defer></script>
  </body>
</html>