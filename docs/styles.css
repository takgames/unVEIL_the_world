:root {
  --bg: #0b0c10;
  --fg: #eaf0f1;
  --muted: #9aa6ac;
  --card: #14161b;
  --card-subtle: #111318;
  --border: #242834;
  --accent: #6ea8fe;
  --accent-2: #a78bfa;
  --normal: #5dd39e; /* 通常=緑 */
  --avg: #ffd166;    /* 平均=黄 */
  --crit: #ff6b6b;   /* 会心=赤 */
  --danger: #ff6b6b;
  --ok: #5dd39e;
  --shadow: 0 6px 18px rgba(0,0,0,.3);
  --input-fz: clamp(16px, 3.6vw, 20px);
  --result-fz: clamp(18px, 4.2vw, 24px);
  --equip-accent: color-mix(in oklab, var(--accent) 26%, transparent);
}

html[data-theme="light"] {
  --bg: #fafafa;
  --fg: #122023;
  --muted: #607078;
  --card: #ffffff;
  --card-subtle: #f4f6f8;
  --border: #e5e8ec;
  --accent: #2b6cb0;
  --accent-2: #6b46c1;
  --shadow: 0 6px 16px rgba(0,0,0,.08);
}

* { box-sizing: border-box }
html,body { height: 100% }
body {
  margin: 0;
  color: var(--fg);
  background: var(--bg);
  font: 16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans JP", sans-serif;
}
.container { width: min(1100px, 100% - 24px); margin: 0 auto; }
.small { font-size: 12px }
.muted { color: var(--muted) }
.row { display: flex; align-items: center }
.wrap { flex-wrap: wrap }
.space-between { justify-content: space-between }
.align-center { align-items: center }
.gap { gap: 12px }
.gap-sm { gap: 8px }
.two-cols { grid-template-columns: repeat(2, minmax(0,1fr)) }

.app-header { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 12px; padding: 16px 0; }
.app-header h1 { margin: 0; font-size: clamp(18px, 2.3vw, 24px) }
.header-actions { display: flex; gap: 8px; }

.btn { cursor: pointer; border: 1px solid var(--border); background: var(--card); color: var(--fg);
  border-radius: 10px; padding: 8px 12px; box-shadow: var(--shadow); }
.btn:hover { filter: brightness(1.06) }
.btn.primary { border-color: var(--accent); }
.btn.danger { border-color: var(--danger); color: #fff; background: linear-gradient(180deg, #ff6b6b, #d94848); }

.main-grid { display: grid; gap: 16px; padding-bottom: 220px; }
.card { border: 1px solid var(--border); border-radius: 14px; background: var(--card); box-shadow: var(--shadow); }
.card > summary { padding: 12px 16px; cursor: pointer; font-weight: 700; list-style: none; }
.card > summary::-webkit-details-marker { display: none }
.card[open] > summary { border-bottom: 1px solid var(--border) }
.card-body { padding: 16px }
.card.subtle { background: var(--card-subtle) }

.grid { display: grid }
.stack { display: grid; gap: 6px }
label > input:not([type=checkbox]):not([type=radio]) { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); font-size: var(--input-fz); }
label > select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); font-size: var(--input-fz); }
select option { font-size: var(--input-fz); }
input[type=number] { font-variant-numeric: tabular-nums; letter-spacing: .02em; }
legend { padding: 0 6px }

/* 装備レイアウト - 確定版 */
.equip-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
.equip-card { position: relative; border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px 12px; background: linear-gradient(180deg, color-mix(in oklab, var(--card) 94%, transparent), var(--card)); box-shadow: 0 1px 3px rgba(0,0,0,.12); }
.equip-card::before { content:""; position:absolute; left:0; top:0; bottom:0; width: 3px; background: var(--equip-accent); border-top-left-radius: inherit; border-bottom-left-radius: inherit; }
.equip-card > legend { font-weight: 700; padding: 0 8px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; }
.subgrid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; margin-top: 8px; }

/* 内訳 */
.breakdown-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px }
.breakdown-grid > div { display: flex; justify-content: space-between; border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px }

/* 結果固定バー */
.results { position: sticky; bottom: 0; z-index: 20; background: linear-gradient(180deg, transparent, rgba(0,0,0,.25)); }
html[data-theme="light"] .results { background: linear-gradient(180deg, transparent, rgba(255,255,255,.6)); }
.results-inner { position: relative; border: 1px solid color-mix(in oklab, var(--accent) 28%, var(--border)); border-radius: 14px; margin: 10px auto; padding: 12px; background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 7%, var(--card)) 0%, var(--card) 60%); box-shadow: var(--shadow), 0 0 0 2px color-mix(in oklab, var(--accent) 10%, transparent); }
.results-head { margin-bottom: 8px }
.legend .chip { border-radius: 999px; padding: 2px 8px; font-size: 12px; border: 1px solid var(--border); }

/* 凡例はバー色と一致 */
.chip-normal { background: color-mix(in oklab, var(--normal) 35%, transparent); }
.chip-avg { background: color-mix(in oklab, var(--avg) 35%, transparent); }
.chip-crit { background: color-mix(in oklab, var(--crit) 45%, transparent); }

.chart { position: relative; height: 22px; border: 1px solid var(--border); border-radius: 1000px; background: linear-gradient(90deg, transparent 0, transparent 100%); overflow: hidden; }
.bar { position: absolute; top: 0; bottom: 0; width: 0; transition: width .2s ease, left .2s ease; mix-blend-mode: normal; }
.bar-normal { left: 0; background: var(--normal); opacity: .95 }
.bar-avg { background: var(--avg); opacity: .95 }
.bar-crit { background: var(--crit); opacity: .95 }
.chart-scale { position: absolute; inset: 0; pointer-events: none; background-image: linear-gradient(90deg, rgba(255,255,255,.14) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,.08) 1px, transparent 1px); background-size: 20% 100%, 10% 100%; }
html[data-theme="light"] .chart-scale { background-image: linear-gradient(90deg, rgba(0,0,0,.06) 1px, transparent 1px); background-size: 10% 100%; }

.results-values { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px }
.results-values > div { display: flex; justify-content: space-between; border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; background: var(--card-subtle) }

.app-footer { padding: 24px 0 40px; color: var(--muted); }

/* ダイアログ */
dialog { border: none; border-radius: 12px; padding: 0; background: transparent; }
.dialog-card { background: var(--card); color: var(--fg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; min-width: min(90vw, 420px); box-shadow: var(--shadow) }
dialog::backdrop { backdrop-filter: blur(2px) brightness(.8) }
dialog:focus { outline: none; }
/* 共有ダイアログ内のボタンは初期強調しない（ホバーのみ色変化） */
.dialog-card .btn { box-shadow: none; transition: background-color .2s ease, color .2s ease, border-color .2s ease; }
.dialog-card .btn.primary { border-color: var(--border); background: var(--card); }
.dialog-card .btn.primary:hover { border-color: var(--accent); background: color-mix(in oklab, var(--accent) 16%, var(--card)); filter: none; }
.dialog-card .btn:focus, .dialog-card .btn:focus-visible { outline: none; box-shadow: none; }

/* トースト：上部に表示 */
#toast { position: fixed; left: 50%; top: calc(12px + env(safe-area-inset-top)); transform: translateX(-50%); z-index: 1000; background: var(--card); color: var(--fg); border: 1px solid var(--border); padding: 10px 14px; border-radius: 10px; box-shadow: var(--shadow); opacity: 0; pointer-events: none; transition: opacity .25s ease; }
#toast.show { opacity: 1 }

@media (max-width: 720px) {
  .two-cols { grid-template-columns: 1fr }
  .results-values { grid-template-columns: 1fr }
}

/* アイコンボタンのレイアウトを中央揃えに（歪み防止） */
.header-actions .btn.icon-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 40px; height: 40px; /* タップしやすい最小44px相当でもOK */
  padding: 0;
}

/* 絵文字サイズと位置の微調整（OS差吸収） */
.btn.icon-btn .emoji {
  font-size: 20px;         /* 18〜22でお好み調整 */
  line-height: 1;
  display: block;
  transform: translateY(1px); /* 絵文字のベースライン補正 */
}

/* ホバー/フォーカスでわずかにトーンアップ（既存の .btn:hover にも連動） */
.btn.icon-btn:hover { filter: brightness(1.06); }
.btn.icon-btn:focus-visible { outline: 2px solid color-mix(in oklab, var(--accent) 50%, transparent); outline-offset: 2px; }

/* 比較コントロール */
.compare-controls { display: flex; align-items: center; gap: 8px; margin: 6px 0 8px; }
.compare-controls select { padding: 4px 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); }
.btn.xs { padding: 4px 8px; font-size: 12px; border-radius: 8px; }

/* 結果ヘッダ右側：比較UI */
.actions-inline { display: flex; align-items: center; gap: 8px; }
.actions-inline select {
  padding: 4px 8px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--bg); color: var(--fg);
}
.btn.xs { padding: 4px 8px; font-size: 12px; border-radius: 8px; }

/* A/Bバッジ（A=現在, B=比較） */
.badgeA, .badgeB {
  border: 1px solid var(--border); border-radius: 999px; padding: 0 8px; font-size: 12px;
  background: var(--card-subtle);
}
.badgeA { border-color: color-mix(in oklab, var(--normal) 45%, var(--border)); }
.badgeB { border-color: color-mix(in oklab, var(--avg) 45%, var(--border)); }

/* ラベルを色チップ化（旧凡例の見た目を踏襲） */
.chip { border-radius: 999px; padding: 2px 8px; font-size: 12px; border: 1px solid var(--border); }
.chip-normal { background: color-mix(in oklab, var(--normal) 35%, transparent); }
.chip-avg    { background: color-mix(in oklab, var(--avg) 35%, transparent); }
.chip-crit   { background: color-mix(in oklab, var(--crit) 45%, transparent); }

/* B(比較)バー：奥にストライプ */
.barB { z-index: 0; opacity: .60; }
.bar  { z-index: 1; }  /* A（現状） */
.barB-normal { left: 0; background: repeating-linear-gradient(45deg, color-mix(in oklab, var(--normal) 70%, transparent) 0 6px, transparent 6px 12px); }
.barB-avg    { background: repeating-linear-gradient(45deg, color-mix(in oklab, var(--avg) 70%, transparent) 0 6px, transparent 6px 12px); }
.barB-crit   { background: repeating-linear-gradient(45deg, color-mix(in oklab, var(--crit) 70%, transparent) 0 6px, transparent 6px 12px); }

/* A>B のときだけ見える“赤ストライプの欠損オーバーレイ” */
.barDef { z-index: 2; pointer-events: none; }
.barDef-normal,
.barDef-avg,
.barDef-crit {
  background: repeating-linear-gradient(135deg, color-mix(in oklab, #d93025 40%, transparent) 0 6px, transparent 6px 12px);
  opacity: .8;
}

/* 差分チップ（既存） */
.delta-chip { margin-left: 8px; border-radius: 999px; padding: 0 6px; font-size: 12px; border: 1px solid var(--border); }
.delta-pos  { color: #0f9d58; border-color: #0f9d58; background: color-mix(in oklab, #0f9d58 12%, transparent); }
.delta-neg  { color: #d93025; border-color: #d93025; background: color-mix(in oklab, #d93025 12%, transparent); }
.delta-zero { color: var(--muted); }

/* 比較セレクトが極小化されないよう最低幅を確保 */
.actions-inline select { min-width: 140px; }

/* “（比較なし）”っぽく見せる（任意） */
.actions-inline select option[value=""] { color: var(--muted); }

/* バッジの縦ズレ対策：ベースライン揃え＋1行高で統一 */
.badge-btn {
  display: inline-flex;
  align-items: baseline;        /* ← ここが効きます */
  gap: 6px;
}

/* 中の要素は行高を揃える */
.badge-btn .label-full,
.badge-btn .label-short,
.badge-btn .name {
  line-height: 1;
}

/* iOSのフォントメトリクス差でまだ気になる場合は微調整（下に0.5px） */
.badge-btn .name {
  transform: translateY(0.5px); /* 気にならなければ 0px にしてOK */
}

/* 既存：名前の省略表示 */
.badgeA .name, .badgeB .name {
  display: inline-block;
  max-width: 34vw;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
@media (max-width: 420px) {
  .badgeA .name, .badgeB .name { max-width: 40vw; }
}

/* ヘッダ右のアクション群 */
.actions-inline { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

/* ラベルは狭いとき短縮表示（A:/B:） */
.label-short { display:none; }
@media (max-width: 420px) {
  .label-full { display:none; }
  .label-short { display:inline; }
  /* iPhone縦：セレクトは隠してバッジで選ぶ */
  #compareSelect { display:none; }
  .actions-inline { gap:6px; }
  .badgeA .name, .badgeB .name { max-width: 40vw; }
}

/* ボトムシート（iOSに馴染むUI） */
dialog.sheet { border:none; padding:0; width:100%; max-width:100%; inset:auto 0 0 0; border-radius:16px 16px 0 0; }
dialog.sheet::backdrop { background: rgba(0,0,0,.35); }
.sheet-inner { background: var(--card); color: var(--fg); padding:12px; max-height: 65vh; overflow:auto; border-radius:16px 16px 0 0; }
.sheet-handle { width:44px; height:4px; background: var(--border-strong); border-radius:2px; margin:6px auto 8px; opacity:.8; }

#cmpSearch { width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:var(--bg); color:var(--fg); }
#cmpList { list-style:none; padding:0; margin:8px 0 0; }
#cmpList li { margin:0; }
#cmpList li button {
  width:100%; text-align:left; padding:10px 12px; border:1px solid var(--border);
  border-radius:10px; background:var(--card-subtle); color:var(--fg);
}
#cmpList li + li button { margin-top:6px; }

/* Bが未選択のとき薄め表示（でもタップ可能） */
.badgeB.empty { opacity: .7; }
